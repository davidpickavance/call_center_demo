<!DOCTYPE html>
<html>
<head>
    <title>Twilio Client Quickstart Please Update</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        .top-margin{
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row top-margin">
            <div class="col-xs-4" id="controls">
                <div id="info">
                    <p>Twilio Client</p>
                    <div id="client-name"></div>
                </div>
            </div>
            <div class="col-xs-4" id="call-controls">
                <div class="form-group">
                    <label for="phone-number">Make a Call:</label>
                    <input type="text" class="form-control" id="phone-number" placeholder="Enter a phone # or client name">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" id="button-call">Call</button>
                    <button type="button" class="btn btn-primary" id="button-hangup">Hangup</button>
                </div>
            </div>
            <div id="log" class="col-xs-4"></div>
        </div>
        <div class="row top-margin">
            <div class="col-xs-4 col-xs-offset-4">
                <section class="agent-activity offline">
                    <h3 class="activity" style="color:red;">Offline</h3>
                    <button class="btn btn-success change-activity" data-next-activity="Idle">Go Available</button>
                </section>
                <section class="agent-activity idle">
                    <h3 class="activity" style="color:green;">Available</h3>
                    <button class="btn btn-danger change-activity" data-next-activity="Offline">Go Offline</button>
                </section>
                <section class="agent-activity reserved">
                    <h3 class="activity" style="color:orange;">Reserved</h3>
                </section>
                <section class="agent-activity busy">
                    <h3 class="activity" style="color:red;">Busy</h3>
                </section>
                <section class="agent-activity wrapup">
                    <h3 class="activity" style="color:orange;">Wrap-Up</h3>
                    <button class="btn btn-success change-activity" data-next-activity="Idle">Go Available</button>
                    <button class="btn btn-danger change-activity" data-next-activity="Offline">Go Offline</button>
                </section>
            </div>
            <div class="col-xs-4">
                <section class="log">
                    <textarea id="log" readonly="true"></textarea>
                </section>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="//media.twiliocdn.com/sdk/js/client/v1.3/twilio.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="/static/quickstart.js"></script>

    <script src="//media.twiliocdn.com/taskrouter/js/v1.4/taskrouter.min.js"></script>
    <script type="text/javascript">
        /* Subscribe to a subset of the available TaskRouter.js events for a worker */
        function registerTaskRouterCallbacks() {
            worker.on('ready', function(worker) {
                agentActivityChanged(worker.activityName);
                logger("Successfully registered as: " + worker.friendlyName)
                logger("Current activity is: " + worker.activityName);
            });

            worker.on('activity.update', function(worker) {
                agentActivityChanged(worker.activityName);
                logger("Worker activity changed to: " + worker.activityName);
            });

            worker.on("reservation.created", function(reservation) {
                logger("-----");
                logger("You have been reserved to handle a call!");
                logger("Call from: " + reservation.task.attributes.from);
                logger("Selected language: " + reservation.task.attributes.selected_language);
                logger("-----");
            });

            worker.on("reservation.accepted", function(reservation) {
                logger("Reservation " + reservation.sid + " accepted!");
            });

            worker.on("reservation.rejected", function(reservation) {
                logger("Reservation " + reservation.sid + " rejected!");
            });

            worker.on("reservation.timeout", function(reservation) {
                logger("Reservation " + reservation.sid + " timed out!");
            });

            worker.on("reservation.canceled", function(reservation) {
                logger("Reservation " + reservation.sid + " canceled!");
            });
        }

        /* Hook up the agent Activity buttons to TaskRouter.js */

        function bindAgentActivityButtons() {
            // Fetch the full list of available Activities from TaskRouter. Store each
            // ActivitySid against the matching Friendly Name
            var activitySids = {};
            worker.activities.fetch(function(error, activityList) {
                var activities = activityList.data;
                var i = activities.length;
                while (i--) {
                    activitySids[activities[i].friendlyName] = activities[i].sid;
                }
            });

            /* For each button of class 'change-activity' in our Agent UI, look up the
             ActivitySid corresponding to the Friendly Name in the buttonâ€™s next-activity
             data attribute. Use Worker.js to transition the agent to that ActivitySid
             when the button is clicked.*/
            var elements = document.getElementsByClassName('change-activity');
            var i = elements.length;
            while (i--) {
                elements[i].onclick = function() {
                    var nextActivity = this.dataset.nextActivity;
                    var nextActivitySid = activitySids[nextActivity];
                    worker.updateActivity(nextActivitySid);
                }
            }
        }

        /* Update the UI to reflect a change in Activity */

        function agentActivityChanged(activity) {
            hideAgentActivities();
            showAgentActivity(activity);
        }

        function hideAgentActivities() {
            var elements = document.getElementsByClassName('agent-activity');
            var i = elements.length;
            while (i--) {
                elements[i].style.display = 'none';
            }
        }

        function showAgentActivity(activity) {
            activity = activity.toLowerCase();
            var elements = document.getElementsByClassName(('agent-activity ' + activity));
            elements.item(0).style.display = 'block';
        }

        /* Other stuff */

        function logger(message) {
            var log = document.getElementById('log');
            log.value += "\n> " + message;
            log.scrollTop = log.scrollHeight;
        }

        window.onload = function() {
            // Initialize TaskRouter.js on page load using window.workerToken -
            // a Twilio Capability token that was set from rendering the template with agents endpoint
            logger("Initializing...");
            window.worker = new Twilio.TaskRouter.Worker("{{ worker_token }}");

            registerTaskRouterCallbacks();
            bindAgentActivityButtons();
        };
    </script>

</body>
</html>